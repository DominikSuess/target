define(["jquery","underscore","config","utils","authModel","common/utils/log","common/utils/logAjaxDuration"],function(e,t,a,r,n,o,i){var s={},c=a("api"),u="cc-data:",d={},l=function(){try{return localStorage.setItem(u,"1"),localStorage.removeItem(u),!0}catch(e){return!1}}(),f=function(e){var t=[];if(e&&e.value)for(var a,n=0;n<e.value.length;n++)a=e.value[n],a.name=r.htmlEncode(a.name||""),t.push(a);return t},h=function(e,t){var a=u+e,r=l?localStorage.getItem(a):d[a],n=JSON.stringify(t),o=r?r==n?0:1:-1;if(0!==o)if(l)try{localStorage.setItem(a,n)}catch(i){return s.clear(),l=!1,h(e,t)}else d[a]=n;return o},m=function(e){e=u+e;var t,a=l?localStorage.getItem(e):d[e];try{t=a&&JSON.parse(a)}catch(r){l&&localStorage.removeItem(e)}return t},p=function(e){return!e.id&&e.location&&(e.id=e.location.split(c).pop()),e.name=r.htmlEncode(e.name||""),e.shared=e.shared||!1,e._isMount=!1,e._isMoving=!1,e._isSharedRoot=!1,e.size=e.size||0,e._isFolder="application/vnd.adobe.stormcloud.collection"==e.type,e.height?e._hasDimensions=!0:(e._hasDimensions=!1,e._isFolder?(e.height=366,e.width=464):(e.height=500,e.width=500)),e.modified&&(e.modified=(new Date).setISO8601(e.modified).getTime()),e.created&&(e.created=(new Date).setISO8601(e.created).getTime()),e.aspect=e.width/e.height,e._defaultIcon=e.type?r.getValidDefaultIcon(e.type,e.name):void 0,e._hasDimensions||e.type||(e._defaultIcon="unknown"),e._sortName=e.name.toLowerCase(),e},v=function(e){var t=m(e),a=m(e+":members"),r=m(t.parent_id+":rootcontext")||[],n=null;if(a){n=[];for(var o,i=a.length-1;i>=0;i--)o=m(a[i]),o&&n.push(o)}return t.members=n,t.rootcontext=r,t},g=function(e){var t=m(e);return t.rootcontext=m(t.parent_id+":rootcontext")||[],t},y=function(e){var t=m(e),a=null;if(t){a=[];for(var r=t.length-1;r>=0;r--)a.push(m(t[r]))}return a},T=function(t,a){e.ajax({type:"GET",dataType:"json",url:c+t+(0===t.indexOf("/collections")?"/header":"/metadata"),headers:{Authorization:n.get("requestHeaderToken")},timeout:2e4}).done(function(e){e.id=t,e.location=c+t;var r=p(e);r.acl=["admin"],h(t,r),a(r)})};s.readObject=m,s.updateResource=function(e,a){var r=m(e)||{id:e};h(e,t.extend(r,a))},s.getSites=function(){var t={},o=e.Deferred(),i=m("entitlements");if(i)return o.resolve(i);var s=function(){return e.ajax({url:(r.cantUseCORS?"/businesscatalyst":a("BUSINESS_CATALYST"))+a("BUSINESS_CATALYST_HAS_SITES_PATH"),dataType:"json",headers:{Authorization:n.get("token")},crossDomain:!0}).then(function(e){var t=40404!==e.statusCode;return t||h("entitlements",{}),t})},c=function(){return e.ajax({url:(r.cantUseCORS?"/businesscatalyst":a("BUSINESS_CATALYST"))+a("BUSINESS_CATALYST_SITES_PATH"),dataType:"json",headers:{Authorization:n.get("token")},crossDomain:!0}).then(function(e){t.sites=e.items})},u=function(){return e.ajax({url:(r.cantUseCORS?"/businesscatalyst":a("BUSINESS_CATALYST"))+a("BUSINESS_CATALYST_ENTITLED_SITES_PATH"),dataType:"json",headers:{Authorization:n.get("token")},crossDomain:!0}).then(function(e){t.totalEntitledSites=e.totalItemsCount||0})};return s().then(function(a){return a?e.when(c(),u()).then(function(){return h("entitlements",t),o.resolve(t)},function(){return o.reject()}):o.resolve({})})},s.addMembers=function(e,a,r){t.isArray(a)||(a=[a]),r=r||function(){};for(var n="archive"==e?e:e+":members",o=m(n)||[],i=t.difference(a,o),s=[],c=i.length,u=function(e){s.push(e),o.push(e.id),s.length==c&&(h(n,t.union(o,m(n)||[])),r(s))},d=c-1;d>=0;d--)T(a[d],u)},s.hasMember=function(e,a){var r="archive"==e?e:e+":members",n=m(r)||[],o=t.indexOf(n,a);return o>=0},s.removeMembers=function(e,a){t.isArray(a)||(a=[a]);var r="archive"==e?e:e+":members",n=m(r)||[];n=t.difference(n,a),h(r,n)},s.refreshSearch=function(a,r,o){r=r||function(){};var s=!1,u=function(){if(!s)return void(o&&o("error fetching search data"));for(var e,n,i,c,u=[],d=[],l=[],f=m("search:"+a),v=s.length-1;v>=0;v--)c=s[v],c.trashed||c.error||(c.parent_id=CCweb.sync_root_id,c.acl=["admin"],c=p(c),n=-1===t.indexOf(f,c.id),e=m(c.id)||{},c=t.extend(e,c),i=h(c.id,c),u.push(c.id),n?d.push(c):i&&l.push(c));h("search:"+a,u);r({removed:t.difference(f,u),added:d,updated:l})};e.ajax({type:"POST",dataType:"json",url:c+"/search",headers:{Authorization:n.get("requestHeaderToken")},timeout:2e4,data:{q:JSON.stringify({name:{$contains:a},trashed:{$ne:!0}}),metadata:!0,startindex:0,maxnumber:9999}}).done(function(e){s=e}).always(i("ccapi.route.search")).always(u)},s.refreshArchive=function(a,r){a=a||function(){};var o=!1,s=function(){if(!o)return void(r&&r("error fetching archive data"));for(var e,n,i,s=[],u=[],d=[],l=m("archive"),f=o.length-1;f>=0;f--)i=o[f],i.trashed&&!i.error&&(i.parent_id=CCweb.sync_root_id,i.acl=["admin"],i.location=c+i.id,i=p(i),e=-1===t.indexOf(l,i.id),n=h(i.id,i),s.push(i.id),e?u.push(i):n&&d.push(i));h("archive",s);a({removed:t.difference(l,s),added:u,updated:d})};e.ajax({type:"POST",dataType:"json",url:c+"/search",headers:{Authorization:n.get("requestHeaderToken")},timeout:2e4,data:{q:JSON.stringify({trashed:!0}),metadata:!0,startindex:0,maxnumber:9999}}).always(i("ccapi.route.archivesearch")).done(function(e){o=e}).always(s)},s.refreshAsset=function(a,r,o){r=r||function(){};var s=c+a,u=!1,d=!1,l=[],m=n.isValid()?3:1,v=t.after(m,function(){if(!u||n.isValid()&&!d)return void(o&&o("error fetching asset data"));u.id=a,u.location=s,u.acl=d;var e=p(u),t=e.parent_id?h(e.parent_id+":rootcontext",l):!1,i=h(a,e);e.rootcontext=l,r({updatedRootcontext:t?l:!1,updatedAttributes:i?u:!1})});e.ajax({type:"GET",dataType:"json",url:s+"/metadata",headers:{Authorization:n.get("requestHeaderToken"),"X-Referer":document.URL},timeout:2e4}).done(function(e){u=e}).always(i("ccapi.route.getassetmetadata")).always(v),n.isValid()&&(e.ajax({type:"GET",dataType:"json",url:s+"/metadata/rootcontext",headers:{Authorization:n.get("requestHeaderToken"),"X-Referer":document.URL}}).done(function(e){l=f(e)}).always(i("ccapi.route.getassetancestors")).always(v),e.ajax({type:"GET",dataType:"json",url:s+"/acl/"+CCweb.models.profile.get("userId").replace("@AdobeID",""),headers:{Authorization:n.get("requestHeaderToken"),"X-Referer":document.URL}}).done(function(e){d=e}).always(v))},s.refreshCollection=function(a,r,o){a=a.replace("/api",""),r=r||function(){};var s=!1,u=!1,d=t.after(2,function(){if(!s)return void(o&&o("error fetching collection data"));u||(u=[]),s.header.location=c+a,s.header.acl=["admin"];for(var e,n,i,d,l=[],f=[],v=[],g=u,y=u.slice(0),T=(m(a),m(a+":members")),S=s.members,x=p(s.header),A=S.length-1;A>=0;A--)d=S[A],d.id=d.location.split("/api").pop(),d.trashed||d.error||(d.parent_id=a,d.acl=["admin"],d=p(d),e=m(d.id)||{},d=t.extend(e,d),n=-1===t.indexOf(T,d.id),i=h(d.id,d),l.push(d.id),n||-1===i?f.push(d):i&&v.push(d));y.push({id:x.id,name:x.name}),h(x.id+":rootcontext",y);var _=m(x.parent_id+":members");_&&-1===t.indexOf(_,x.id)&&(_.push(x.id),h(x.parent_id+":members",_));var j=h(x.parent_id+":rootcontext",g),b=(h(a+":members",l),h(a,x));x.rootcontext=g,r({updatedAttributes:b||j?x:!1,removed:t.difference(T,l),added:f,updated:v})});e.ajax({type:"GET",dataType:"json",url:c+a+"/header/rootcontext",headers:{Authorization:n.get("requestHeaderToken")}}).done(function(e){u=f(e)}).always(i("ccapi.route.getcollectionancestors")).always(d),e.ajax({type:"GET",dataType:"json",url:c+a,headers:{Authorization:n.get("requestHeaderToken")},timeout:5e4}).done(function(e){s=e}).always(i("ccapi.route.getcollectionmetadata")).always(d)},s.getAssetComments=function(t){return e.ajax({type:"GET",contentType:"application/json",url:CCweb.config.api+t+"/comments",headers:{Authorization:n.get("requestHeaderToken"),"X-Referer":document.URL}})},s.addAssetComment=function(t,a){return e.ajax({type:"POST",contentType:"application/json",url:CCweb.config.api+t+"/comments",headers:{Authorization:n.get("requestHeaderToken"),"X-Referer":document.URL},data:JSON.stringify({_target:t,commenter_name:a.name,commenter_email:a.email,content:a.text})})},s.deleteAssetComment=function(t,a){return e.ajax({type:"DELETE",contentType:"application/json",url:CCweb.config.api+t+"/comments/"+a,headers:{Authorization:n.get("requestHeaderToken"),"X-Referer":document.URL}})},s.getAssetMigrationStatus=function(t){return e.ajax({type:"GET",contentType:"application/json",url:c+"/share/assets/"+t})},s.archive=function(){return y("archive")},s.search=function(e){return y("search:"+e)},s.collection=function(e){return m(e)||h(e,{id:e}),v(e)},s.asset=function(e){return m(e)||h(e,{id:e}),g(e)},s.createCollection=function(t,a){return e.ajax({type:"POST",contentType:"application/json",url:c+"/collections",data:JSON.stringify({header:{name:t,type:"application/vnd.adobe.stormcloud.collection",parent_id:a}}),headers:{Authorization:n.get("requestHeaderToken")}})},s.setResourceName=function(t,a){var r=-1===a.indexOf("assets"),n=a+(r?"/header":"/metadata/name"),o=r?{name:t}:{value:t};return e.ajax({type:"PUT",contentType:"application/json",url:n,headers:{Authorization:CCweb.models.auth.get("requestHeaderToken")},data:JSON.stringify(o)})},s.moveResources=function(t,r){return e.ajax({type:"POST",contentType:"application/json",url:a("api")+r,timeout:4e4,headers:{Authorization:n.get("requestHeaderToken")},data:JSON.stringify({members_to_move:t})})},s.deleteResources=function(a){var o=e.Deferred();if(!a||0===a.length)return o;var i=r.queue({concurrent:3,items:a,process:function(t,a){e.ajax({type:"DELETE",url:t.location,headers:{Authorization:n.get("requestHeaderToken")}}).fail(a.stop).done(a.callback)},stopped:o.reject,complete:o.resolve});i.start();var c=a[0].trashed?"archive":a[0].parent_id;return s.removeMembers(c,t.pluck(a,"id")),o};var S=function(a,o){o=t.isArray(o)?o:[o];var i=e.Deferred(),s=r.queue({concurrent:3,items:o,process:function(t,r){var o=t.location+(t._isFolder?"/header?recursive=true":"/metadata/trashed"),i=t._isFolder?{trashed:a}:{value:a};e.ajax({type:"PUT",contentType:"application/json",timeout:2e4,url:o,headers:{Authorization:n.get("requestHeaderToken")},data:JSON.stringify(i)}).done(r.callback).fail(r.stop)},stopped:i.reject,complete:i.resolve});return s.start(),i};return s.archiveResources=function(e){var t=S(!0,e);return t},s.restoreResources=function(e){var t=S(!1,e);return t},s.buildId=function(e){return e?h("buildId",e):e=m("buildId"),e},s.clear=function(){if(!l)return d={},s;for(var e,t=localStorage.length-1;t>=0;t--)e=localStorage.key(t),0===e.indexOf(u)&&localStorage.removeItem(e);return s},s});