CCweb.collection_plans=Backbone.Collection.extend({initialize:function(e,t){t=t||{},this.model=CCweb.model_plan,t.updatePricesOnCurrencyChange&&CCweb.models.currency.on("change:currency",this.updatePrices,this),t.updatePricesOnReset&&this.on("reset",this.updatePrices),this.reset(CCweb.plans,{parse:!0})},getOffersByButtonLink:function(e){return this.filter(function(t){return t.has("button")?t.get("button").link===e:!1})},getOffersByTab:function(e){return this.filter(function(t){return t.get("tabId")===e})},getOffersByMarketSegment:function(e){return this.filter(function(t){return t.get("marketSegment")===e})},getCorrespondingSingleAppOffer:function(e){var t=this.filter(function(t){return t.get("templateType")===e&&"single_app"===t.get("planType")});return t[0]},getPurchaseProductKeysByMarketSegment:function(e,t){var r=[];return t=t||"offers",_.each(this.getOffersByMarketSegment(e),function(e){var n=e.get("priceService")||"offers";n===t&&(r=_.union(r,e.getPurchaseProductKeys()))}),_.uniq(r)},getDigitalRiverProductKeysByMarketSegment:function(e){var t=[];return _.each(this.getOffersByMarketSegment(e),function(e){t=_.union(t,e.getDigitalRiverProductKeys())}),_.uniq(t)},getOffersByPurchaseProductKey:function(e){return this.filter(function(t){return t.containsPurchaseProductKey(e)})},getOffersByDigitalRiverProductKey:function(e){return this.filter(function(t){return t.containsDigitalRiverProductKey(e)})},updatePrices:function(){var e=CCweb.models.currency.get("currency"),t=CCweb.util.isDigitalRiverCustomer(e),r=CCweb.util.defaultToEnglishOnlyProductCode(e)?"EN":"MULTI",n=null,i=this;if(CCweb.models.auth.isValid())n=CCweb.models.profile.get("countryCode");else{var u=CCweb.util.getParam("store_code");n=!u||CCweb.util.hasFeature("ccm_bug_fix")&&!CCweb.util.isValidCountry(u)?CCweb.models.ip_profile.getValidCountryCode():CCweb.util.hasFeature("ccm_bug_fix")?u:"eu"===u.toLowerCase()?null:u}if(n&&CCweb.util.currencyMap[n.toLowerCase()]!==e&&(n=null),_.each(["COM","EDU"],function(u){var c=t?i.getDigitalRiverProductKeysByMarketSegment(u):i.getPurchaseProductKeysByMarketSegment(u);c.length>0&&CCweb.util.getPriceForProducts({jsonpCallback:"PLANS_PRICES_"+u+"_"+e,productCodes:c,currency:e,countryCode:n?n:e,marketSegment:u,targetLanguage:r,success:function(r){if(CCweb.models.currency.get("currency")===e){var n=t?i.getOffersByDigitalRiverProductKey(r.productKey):i.getOffersByPurchaseProductKey(r.productKey);_.each(n,function(e){e.updatePrice(r)})}}})}),CCweb.util.isDeviceLicensingPurchasingCountry(e)){var c=this.getPurchaseProductKeysByMarketSegment("EDU","ccproducts");c.length>0&&(CCweb.util.hasFeature("temp_device_single_app")?_.each(c,function(t){var u=[];u.push(t),CCweb.util.getPriceForCCProducts({productCodes:u,countryCode:n?n:e,marketSegment:"EDU",targetLanguage:r,useCaching:CCweb.util.hasFeature("enable_caching_device_licensing_api"),success:function(t){if(CCweb.models.currency.get("currency")===e){var r=i.getOffersByPurchaseProductKey(t.productKey);_.each(r,function(e){e.updatePrice(t)})}}})}):CCweb.util.getPriceForCCProducts({productCodes:c,countryCode:n?n:e,marketSegment:"EDU",targetLanguage:r,useCaching:CCweb.util.hasFeature("enable_caching_device_licensing_api"),success:function(t){if(CCweb.models.currency.get("currency")===e){var r=i.getOffersByPurchaseProductKey(t.productKey);_.each(r,function(e){e.updatePrice(t)})}}}))}}});