CCweb.view_cart=Backbone.View.extend({className:"cart",events:{"change .select_service_commitment":"onServiceCommitmentSelectChange","click .language_switch_link":"onLanguageSwitchLinkClick","click .buy_now":"onBuyNowClick"},initialize:function(e){e=e||{},_.bindAll(this,"render"),this.model=e.model,this.collection=this.model.get("items");var t=CCweb.config.locale;this.defaultButtonText=CCweb.util.loc("en"===t||"en-us"===t||"ja"===t?"BUY NOW":"JOIN");var i=this.model.get("buttonText")?this.model.get("buttonText"):this.defaultButtonText;this.template=_.template('<div class="empty_cart">'+CCweb.util.loc("Nothing has been selected")+'</div><div class="cart_items"><div class="cart_items_header">'+CCweb.util.loc("You've selected:")+'</div><div class="selected_products_list"/><hr class="selected_products_rule"></div><div class="commitment_select_container"><select class="select_service_commitment"><option value="YEAR"><%= CCweb.util.loc("Annual plan, paid monthly") %></option><option value="YEAR_PREPAID"><%= CCweb.util.loc("Annual plan, prepaid") %></option></select></div><div class="language_switch"><a class="language_switch_link en"><%= CCweb.util.loc("Switch to the English language membership") %></a><a class="language_switch_link multi"><%= CCweb.util.loc("Switch to the multiple language membership") %></a></div><div class="total_price"><div class="total_price_label"><%= CCweb.util.loc("Subtotal:") %></div><div class="price_amount">...</div><div class="total_price_tax_label"></div></div><a class="btn primary buy_now">'+i+"</a>"),this.itemViews=[],this.model.on("change:totalPriceWithoutTax",this.onTotalPriceChange,this),this.model.on("change:targetLanguage",this.onTargetLanguageChange,this),this.model.on("change:serviceCommitment",this.onServiceCommitmentChange,this),this.model.on("change:buttonText",this.setButtonText,this),this.collection.on("add",this.onCollectionAdd,this),this.collection.on("remove",this.onCollectionRemove,this)},render:function(){return this.$el.empty().append(this.template()),this.delegateEvents(),this.model.isEmpty()?(this.$(".cart_items").hide(),this.disableButton()):(this.$(".empty_cart").hide(),this.addCartItems()),this.updateServiceCommitment(),this.updateLanguageLinks(),this.updateTotalPrice(),this},createItemViews:function(){var e=this;_.each(this.collection.models,function(t){var i=new CCweb.view_cart_item({model:t,cartModel:e.model}).render();e.$(".selected_products_list").append(i.$el),e.itemViews.push(i)})},addCartItems:function(){var e=this;0===this.itemViews.length&&this.createItemViews(),_.each(this.itemViews,function(t){e.$(".selected_products_list").append(t.render().$el)})},updateServiceCommitment:function(){this.$(".select_service_commitment").val(this.model.get("serviceCommitment"))},updateLanguageLinks:function(){var e=this.model.isEmpty();this.$(".language_switch_link").hide(),this.model.allowsEnSwitch()&&!e&&(this.model.isEnTargetLanguage()?this.$(".language_switch_link.multi").show():this.$(".language_switch_link.en").show())},updateTotalPrice:function(){var e=this.model.get("totalPriceWithoutTax"),t=this.model.isYearPrepaidServiceCommitment()?CCweb.util.loc("{0} / yr",'<span class="price">'+e+"</span>"):CCweb.util.loc("{0} / mo",'<span class="price">'+e+"</span>");this.$(".total_price .price_amount").empty().append(t);var i=CCweb.models.currency.get("currency"),s=CCweb.util.getGenericPlusTaxString(i);s&&this.$(".total_price_tax_label").html(s)},setButtonText:function(){var e=this.model.get("buttonText");this.$(".btn.buy_now").html(e?e:this.defaultButtonText)},saveCartToSessionStorage:function(){var e=this.model.toJSON(),t=CCweb.util.getTeamCartModelSessionStorageKey(this.model.get("type"));CCweb.util.sessionStorageSet(t,JSON.stringify(e))},enableButton:function(){this.$(".btn.buy_now").hasClass("disabled")&&this.$(".btn.buy_now").removeClass("disabled")},disableButton:function(){this.$(".btn.buy_now").hasClass("disabled")||this.$(".btn.buy_now").addClass("disabled")},getEventIdFromIdMap:function(e){if(e){var t=this.model.hasComplete(),i=this.model.hasSingleApp(),s="complete";t&&i?s="completeAndSingleAppMix":i&&(s="singleApp");var n=e[s];if(n)return n[this.model.get("serviceCommitment")]}return null},onCollectionAdd:function(e){if(e){this.$(".empty_cart").hide(),this.$(".cart_items").show();var t=new CCweb.view_cart_item({model:e,cartModel:this.model}).render();this.$(".selected_products_list").append(t.$el),this.itemViews.push(t),this.updateTotalPrice(),this.updateLanguageLinks(),this.enableButton()}return!1},onCollectionRemove:function(e){if(e){var t=_.find(this.itemViews,function(t){return t.model.get("productCode")===e.get("productCode")});t.$el.remove(),this.itemViews=_.without(this.itemViews,t),this.itemViews&&0===this.itemViews.length&&(this.$(".cart_items").hide(),this.$(".empty_cart").show(),this.disableButton()),this.updateLanguageLinks(),this.updateTotalPrice()}return!1},onServiceCommitmentSelectChange:function(){var e=this.$(".select_service_commitment").val();return this.model.switchServiceCommitment(e),!1},onLanguageSwitchLinkClick:function(){return this.model.allowsEnSwitch()&&this.model.switchTargetLanguage(this.model.isMultiTargetLanguage()?this.model.TARGET_LANGUAGE.EN:this.model.TARGET_LANGUAGE.MULTI),this.updateLanguageLinks(),!1},onBuyNowClick:function(e){if(e&&e.currentTarget&&!$(e.currentTarget).hasClass("disabled")){var t=this.getEventIdFromIdMap(this.model.get("trackingIds"));t&&CCweb.events.trigger(t),this.saveCartToSessionStorage();var i=this.model.getJoinLink();if(CCweb.models.auth.isValid())CCweb.models.auth.isEnterpriseUser(CCweb.models.profile.get("userId"))?CCweb.models.auth.blockEnterpriseUser():window.location=i;else{var s=this.model.get("scJoinStep1Id");s&&CCweb.events.trigger(s);var n=this.getEventIdFromIdMap(this.model.get("susiACValues"));n&&(window.adobeid.api_parameters.authorize.state.ac=n);var o=this.model.get("susiContextId");o&&(window.adobeid.api_parameters.authorize.ctx_id=o),window.adobeid.api_parameters.authorize.force_marketing_permission=!1,window.adobeid.redirect_uri=window.location.protocol+"//"+window.location.host+i;var a=this.model.get("type");_.delay(function(){var e="sign_up";"offer"===a&&(e="sign_in"),CCweb.events.trigger(e,CCweb.config.IDP_CLIENT_ID_JOIN_WORKFLOW_SUSI)},200)}}return!1},onServiceCommitmentChange:function(){return this.updateTotalPrice(),!1},onTargetLanguageChange:function(){return this.updateLanguageLinks(),!1},onTotalPriceChange:function(){return this.updateTotalPrice(),!1},onClose:function(){this.model.off("change:totalPriceWithoutTax",this.onTotalPriceChange,this),this.model.off("change:targetLanguage",this.onTargetLanguageChange,this),this.model.off("change:serviceCommitment",this.onServiceCommitmentChange,this),this.model.off("change:buttonText",this.setButtonText,this),this.collection.off("add",this.onCollectionAdd,this),this.collection.off("remove",this.onCollectionRemove,this)}});