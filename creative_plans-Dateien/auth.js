define(["jquery","underscore","backbone","config","utils","events","translate","common/utils/log","text!./global-profile/profile.html","css!./global-profile/profile.css"],function(e,t,i,o,n,a,r,s,l){var d="redirect",c=!1,u=n.getSUSIClientID(),g=t.template(l),w=n.getGlobalNavSections(),b=n.getGlobalNavHoverColor(),h=n.getSUSIScope(),m=i.Model.extend({_isReady:!1,defaults:{isTeamAdmin:!1,isTeamDelegate:!1,serviceLevel:"CS_LVL_1",expiresDate:0,token:"",requestHeaderToken:"",boundRengaToken:"none",userData:{}},initialize:function(){t.bindAll(this,"initSusi","loadScript","setAuthData","clearAuthData","signIn","signOut","signUp","isValid","setUser","imsCheckTeamRole","setMode"),CCweb.events.bind("sign_out",this.signOut),CCweb.events.bind("sign_in",this.signIn),CCweb.events.bind("sign_up",this.signUp),this.clearAuthData(),this.initSusi(),require(["files/dataStore"],function(e){e.clear()})},initSusi:function(){{var t=this;window.location.hash}n.localStorageRemove("cc-post-signin-redirect");var i=(o("IMS_SCOPE_SUSI"),CCweb.config.ccm_env),a="";"stage"===i&&(a="stg1");var r="redirect"===d?!0:!1;window.adobeid={scope:h,uses_redirect_mode:r?!0:!1,uses_modal_mode:r?!1:!0,is_mandatory_sign_in:c,target_env:a,onProfile:function(e){e&&(t.setUser(e),e.userId&&CCweb.events.trigger("user_signed_in",{userGuid:e.userId}))},onAccessToken:function(e){e&&(t.set("token",e),t.set("requestHeaderToken","Bearer "+e))},onReady:function(){CCweb.util.hasFeature("performance_profiling")&&(CCweb.events.trigger("adobeid_onReady:end"),CCweb.events.trigger("adobeid_checkTeamRole:start")),CCweb.util.hasFeature("temp_ims_optimize")&&(t._isReady=!0),window.adobeIMS.isSignedInUser(!1)?t.imsCheckTeamRole(function(){CCweb.util.hasFeature("performance_profiling")&&(CCweb.events.trigger("adobeid_checkTeamRole:end"),CCweb.events.trigger("auth_model:end")),t.trigger("ready")}):(CCweb.util.hasFeature("performance_profiling")&&CCweb.events.trigger("auth_model:end"),t.trigger("ready"))},onError:function(){"redirect"!=d?require(["common/splash-screens/unplanned-outage/view"],function(t){e("#content").html((new t).render().$el)}):t.trigger("ready")},api_parameters:{authorize:{dc:!1,force_marketing_permission:!0,state:{ac:"creative.adobe.com"}}}},e("head").append('<link rel="stylesheet" type="text/css" href="'+o("IMS_PROFILE_ENDPOINT")+'/css/globalnav.css"/>'),e("body").prepend(g),e("#globalnav__header").remove(),CCweb.util.hasFeature("performance_profiling")&&CCweb.events.trigger("global_nav:start"),require([o("IMS_PROFILE_ENDPOINT")+"/js/globalnav.js"],function(e){new e({adobeid:window.adobeid,parentSelector:".new-profile",sections:w,locale:n.localeMap[o("locale")],events:{signOut:function(){t.signOut()}},styles:{buttonTextColor:"#999999",buttonTextHoverColor:b},defaultSitemapSection:t.getDefaultSitemapSection()});CCweb.util.hasFeature("performance_profiling")&&CCweb.events.trigger("global_nav:end"),t.loadScript()})},loadScript:function(){var t=o("IDP_ENDPOINT")+"/ims/imslib.js?client_id="+u+"&locale="+n.localeMap[o("locale")];CCweb.util.hasFeature("performance_profiling")&&CCweb.events.trigger("imslib_load:start");var i=this;e.ajax({url:t,dataType:"script",cache:!0}).done(function(){CCweb.util.hasFeature("performance_profiling")&&(CCweb.events.trigger("imslib_load:end"),CCweb.events.trigger("adobeid_onReady:start")),s("auth:imslib-loaded"),i.trigger("imslibLoaded")}).fail(function(){s("auth:imslib-not-loaded"),"redirect"!=d?require(["common/splash-screens/unplanned-outage/view"],function(t){e("body").html((new t).render().$el)}):i.trigger("ready")})},getCurrentLocation:function(){var e=CCweb.util.getParam("location"),t=window.location.pathname.length>1?window.location.pathname:location.hash;if(CCweb.util.isIE9OrEarlier()&&CCweb.util.isLocaleInPath(t)&&(t=window.location.pathname+window.location.hash.replace(/^#?/,"")),t=("/"===t[0]?t.substring(1):t).replace("#",""),0===t.indexOf("file")&&-1===t.indexOf("filechooser"))t="/files";else if(e&&0===t.indexOf("share"))t="/share?location="+e;else if(window.location.search){var i=CCweb.util.isIE9OrEarlier()?"/"+t:window.location.pathname;t=i+window.location.search}else t="/"+t;return t},getDefaultSitemapSection:function(){if(n.isPlansSection()){var e=n.getCurrentPath();if(e.indexOf("photography")<0&&e.indexOf("photoshop+lightroom")<0)return"how-to-buy"}return"products"},setAuthData:function(e){this.set(e);var t=n.getCookie("creative-cloud-remember"),i=this.get("token");i&&n.setCookie(o("SESSION_COOKIE_KEY"),i.substring(0,10),t&&"true"===t?336:null),n.localStorageSet(o("SESSION_KEY"),JSON.stringify(this.toJSON())),n.setCookie("creative-cloud-e",this.get("token"),null,!0),n.setCookie("creative-cloud-validated",!0,.033)},clearAuthData:function(e){var t=n.getCookie("creative-cloud-remember");this.clear(e===!0?{silent:!1}:{silent:!0}),n.localStorageRemove(o("SESSION_KEY")),n.setCookie("creative-cloud-e","",-1),(!t||t&&"true"!==t)&&(n.setCookie(o("SESSION_COOKIE_KEY"),"",-1),n.setCookie("creative-cloud-validated","",-1),n.setCookie("creative-cloud-product-code","",-1),n.setCookie("creative-cloud-remember","",-1),n.setCookie("creative-cloud-email","",-1))},signOut:function(){s("auth:sign-out");var e=CCweb.config.ccm_env,t=window.location.protocol+"//www"+("prod"!==e?".stage":"")+".adobe.com";a.trigger("info-msg-logout"),window.adobeid.redirect_uri=n.hasFeature("temp_update_nav")&&(n.isFilesSection()||n.isTeamSection()||n.isStarterSection())?t:null,window.adobeIMS&&window.adobeIMS.signOut?(this.clearAuthData(!0),window.adobeIMS.signOut()):CCweb.events.trigger("create_notify","text",null,r("Sign out is unavailable at this time. Please try again later."))},signIn:function(e){s("auth:sign-in"),window.adobeIMS&&window.adobeIMS.signIn?e?window.adobeIMS.signIn({client_id:e}):window.adobeIMS.signIn():CCweb.events.trigger("create_notify","text",null,r("Sign in is unavailable at this time. Please try again later."))},signUp:function(e){s("auth:sign-up"),window.adobeIMS&&window.adobeIMS.signUp?(window.adobeid.api_parameters.authorize.idp_flow="create_account",window.adobeid.api_parameters.authorize.eu&&window.adobeid.api_parameters.authorize.puser||(window.adobeid.api_parameters.authorize.el=!0),e?window.adobeIMS.signUp({client_id:e}):window.adobeIMS.signUp()):CCweb.events.trigger("create_notify","text",null,r("Sign up is unavailable at this time. Please try again later."))},reAuthenticate:function(e,t){window.adobeIMS&&window.adobeIMS.reAuthenticate?(t&&(window.adobeid.api_parameters.authorize.ctx_id=t),CCweb.util.isIE9OrEarlier()&&(window.adobeid.redirect_uri=window.location.protocol+"//"+window.location.host+"/"+CCweb.util.getCurrentPath()),window.adobeIMS.reAuthenticate({reauth:"force"},e)):CCweb.events.trigger("create_notify","text",null,r("Reauthentication is unavailable at this time. Please try again later."))},getReAuthenticationContextObject:function(){return window.adobeIMS&&window.adobeIMS.getContextFromRedirectForAccessToken&&window.adobeIMS.getAccessToken?window.adobeIMS.getContextFromRedirectForAccessToken(window.adobeIMS.getAccessToken(!0)):null},getUserProfile:function(){return s("auth:sign-up"),window.adobeIMS&&window.adobeIMS.getUserProfile?window.adobeIMS.getUserProfile():void CCweb.events.trigger("create_notify","text",null,r("User profile is unavailable at this time. Please try again later."))},imsCheckTeamRole:function(t){var i=this,a=!1,r=!1,l=this.get("token");e.ajax({url:o("IDP_ENDPOINT")+"/ims/organizations/v1",dataType:"jsonp",data:{bearer_token:l,client_id:n.getClientIDFromToken(l)}}).done(function(e){for(var t=e.orgs||[],i=0;i<t.length;i++)for(var o=t[i].groups||[],n=0;n<o.length;n++){var s=o[n];"TEAM_MEMBER"===s.role&&(r=!0),"GRP_ADMIN"===s.role&&(a=!0)}}).fail(function(){s("auth:ims-organizations-call-failed")}).always(function(){i.setAuthData({isTeamDelegate:r,isTeamAdmin:a}),t()})},isReady:function(){return this._isReady},isValid:function(){if(CCweb.FLAGS.preview_mode===!0)return!1;var e=parseInt(this.get("expiresDate"),10)-(new Date).getTime();return window.adobeIMS&&window.adobeIMS.isSignedInUser&&window.adobeIMS.isSignedInUser(!1)?!0:(this.get("expiresDate")&&0>=e&&n.localStorageSet("cc-auth-expired","true"),this.clearAuthData(),!1)},setUser:function(e){this.set("serviceLevel",e.serviceAccounts&&e.serviceAccounts[0]?e.serviceAccounts[0].serviceLevel:null),this.set("userData",{userId:e.userId||"",countryCode:e.countryCode||"",emailVerified:e.emailVerified||"",displayName:e.displayName||"",name:e.name||"",first_name:e.first_name||"",last_name:e.last_name||"",email:e.email||""})},setMode:function(e){"redirect"===e?(d="redirect",c=!1):"modal"===e?(d="modal",c=!1):"autoRedirect"===e&&(d="redirect",c=!0);var t="redirect"===d?!0:!1;window.adobeid.uses_redirect_mode=t?!0:!1,window.adobeid.uses_modal_mode=t?!1:!0,window.adobeid.is_mandatory_sign_in=c,this.signIn()},setClientId:function(e){u=e},setGlobalNavSections:function(e){w=e},setSiteCatalystACValue:function(e){window.adobeid.api_parameters.authorize.state.ac=e},isEnterpriseUser:function(e){return e&&-1===e.indexOf("@AdobeID")},blockEnterpriseUser:function(){var e={client_id:o("IDP_CLIENT_ID_PAID_WORKFLOW_SUSI"),scope:o("IMS_SCOPE_SUSI"),response_type:"token",redirect_uri:window.location.protocol+"//"+window.location.host+"/"+n.getCurrentPath(),locale:n.localeMap[o("locale")]},i=o("IDP_ENDPOINT")+o("IMS_AUTH_LOC")+"?";t.each(e,function(e,t){i=i+encodeURIComponent(t)+"="+encodeURIComponent(e)+"&"}),window.open(i,"_self")}});return new m});